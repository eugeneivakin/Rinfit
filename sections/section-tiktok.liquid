{{ 'section-tiktok.css' | asset_url | stylesheet_tag }}

<section>
    {% if section.settings.main_title != blank %}
        <div class="main-title-tiktok">{{ section.settings.main_title }}</div>
    {% endif %}
    <div class="container-main-swiper-tiktok">
        <div class="swiper main-swiper-tiktok">
            <div class="swiper-wrapper swiper-wrapper-titktok">
                {% for block in section.blocks %}
                    <div class="swiper-slide swiper-slide-titktok">
                        <div>
                            <div class="video-item video-item-tiktok">
                                <div>
                                    <video class="myVideo" src="{{block.settings.video_file.sources[1].url}}" loop muted playsinline></video>
                                </div>
                                {% if block.settings.main_url != blank %}
                                    <a class="main-link-video" href='{{ block.settings.main_url }}'>
                                        <span class="main-link-video__text">{{ 'sections.shop_the_look.view_product' | t }}</span>
                                        <img src="{{ 'Vector112.svg' | asset_url }}" alt="Icon"/>
                                    </a>
                                {% endif %}
                                <div class="start_video">
                                    {{ "Vector1234.svg" | asset_url | img_tag: "Play Icon", "playBtn" }}
                                    <svg class="pauseBtn" xmlns="http://www.w3.org/2000/svg" width="27" height="27" fill="currentColor" style="color: white; cursor:pointer; display:none;" viewBox="0 0 16 16">
                                        <path d="M5.5 3.5A1.5 1.5 0 0 1 7 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5zm5 0A1.5 1.5 0 0 1 12 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5z"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="continer-bottom-tiktok">
                                {% if block.settings.main_product.featured_image != blank %}
                                    <a class="main-url-tiktok-product" href="{{ block.settings.main_product.url }}">
                                        {{ block.settings.main_product.featured_image | image_url: width: block.settings.main_product.featured_image.width | image_tag}}
                                    </a>
                                {% endif %}
                                <div>
                                    <a class="main-url-tiktok-product" href="{{ block.settings.main_product.url }}">
                                        <div class="main-slide-tiktok">
                                            {{ block.settings.main_product.title  }}
                                        </div>
                                    </a>
                                    {% if product.compare_at_price > product.price %}
                                        <span class="old-price price-slide-tiktok-product">
                                            {{ block.settings.main_product.compare_at_price | money }}
                                        </span>
                                        <span class="sale-price price-slide-tiktok-product">
                                            {{ block.settings.main_product.price | money }}
                                        </span>
                                    {% else %}
                                        <span class="price price-slide-tiktok-product">
                                            {{ block.settings.main_product.price | money }}
                                        </span>
                                    {% endif %}
                                </div>
                                <div class="tiktok-product__arrow">
                                    {{ "VectorModal.svg" | asset_url | img_tag: "Next" }}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
        <div class="swiper-button-next-tiktok">
            {{ "VectorModal.svg" | asset_url | img_tag: "Next" }}  
        </div>
        <div class="swiper-button-prev-tiktok">
            {{ "VectorModal.svg" | asset_url | img_tag: "Prev" }}  
        </div>
    </div>
</section>  

{% comment %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css" />
<script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>
{% endcomment %}

<script>
let swiper;

function initSwiper(loopEnabled) {
    swiper = new Swiper('.main-swiper-tiktok', {
        slidesPerView: 1.5,
        centeredSlides: true,
        loop: loopEnabled,
        speed: 600,
        navigation: {
            nextEl: '.swiper-button-next-tiktok',
            prevEl: '.swiper-button-prev-tiktok',
        },
        breakpoints: {
            470: { slidesPerView: 2 },
            570: { slidesPerView: 2.2 },
            768: { slidesPerView: 3 },
            1024: { slidesPerView: 3 },
            1440: { slidesPerView: 5 }
        }
    });
}

function destroySwiper() {
    if (swiper && !swiper.destroyed) {
        swiper.destroy(true, true);
        swiper = null;
    }
}

function isInViewport(element) {
    const rect = element.getBoundingClientRect();
    const windowHeight = (window.innerHeight || document.documentElement.clientHeight);
    const windowWidth = (window.innerWidth || document.documentElement.clientWidth);

    return (
        rect.bottom > 0 &&
        rect.right > 0 &&
        rect.top < windowHeight &&
        rect.left < windowWidth
    );
}

let scrollTimeout;
window.addEventListener('scroll', () => {
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(() => {
        if (swiper && !swiper.destroyed) {
            playVideoInActive(swiper);
        }
    }, 100);
});

function checkSwiperVisibility() {
    const container = document.querySelector('.main-swiper-tiktok');
    const containerWrapper = document.querySelector('.container-main-swiper-tiktok');
    const swiperWrapper = container.querySelector('.swiper-wrapper.swiper-wrapper-titktok');

    if (!container || !containerWrapper || !swiperWrapper) return;


    const allSlides = container.querySelectorAll('.swiper-slide');
    const slides = Array.from(allSlides).filter(slide => !slide.classList.contains('swiper-slide-duplicate'));

    if (slides.length === 0) return;

    const containerWidth = container.offsetWidth;
    let totalSlidesWidth = 0;

    slides.forEach(slide => {
        totalSlidesWidth += slide.offsetWidth;
    });

    if (totalSlidesWidth <= containerWidth) {
        containerWrapper.classList.add('swiper-disabled');
        destroySwiper();
                swiperWrapper.classList.add('centered-swiper');

    } else {
        containerWrapper.classList.remove('swiper-disabled');
        swiperWrapper.classList.remove('centered-swiper');

        let slidesPerView = 1.5;
        const w = window.innerWidth;
        if (w >= 1440) slidesPerView = 5;
        else if (w >= 1024) slidesPerView = 3;
        else if (w >= 768) slidesPerView = 3;
        else if (w >= 570) slidesPerView = 2.2;
        else if (w >= 470) slidesPerView = 2;

        const loopNeeded = slides.length > slidesPerView;

        destroySwiper();
        initSwiper(loopNeeded);
    }
}

window.addEventListener('load', checkSwiperVisibility);

let resizeTimeout;
window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
        checkSwiperVisibility();
        if (swiper && !swiper.destroyed) {
            playVideoInActive(swiper);
        }
    }, 200);
});


document.addEventListener('click', (e) => {
    const playBtn = e.target.closest('.playBtn');
    const pauseBtn = e.target.closest('.pauseBtn');

    if (playBtn) {
        const item = playBtn.closest('.video-item');
        const video = item.querySelector('.myVideo');
        const pauseBtn = item.querySelector('.pauseBtn');
        const slide = item.closest('.swiper-slide');
        const realIndex = Number(slide.getAttribute('data-swiper-slide-index'));

        if (swiper && !swiper.destroyed) {
            const currentIndex = swiper.realIndex;

            if (realIndex === (currentIndex + 1) % swiper.slides.length) {
                document.querySelector('.swiper-button-next-tiktok')?.click();
            } else if (realIndex === (currentIndex - 1 + swiper.slides.length) % swiper.slides.length) {
                document.querySelector('.swiper-button-prev-tiktok')?.click();
            } else {
                const total = swiper.slides.length - swiper.loopedSlides * 2; 
                if (swiper.params.loop) {
                    let diff = realIndex - currentIndex;
                    if (diff > total / 2) diff -= total; 
                    if (diff < -total / 2) diff += total;   
                    swiper.slideTo(swiper.activeIndex + diff, 600);
                } else {
                    const slideIndex = Array.from(swiper.slides).indexOf(slide);
                    swiper.slideTo(slideIndex, 600);
                }
            }
        }

        video.muted = false;
        video.play();
        playBtn.style.display = 'none';
        pauseBtn.style.display = 'inline-block';
    }

    if (pauseBtn) {
        const item = pauseBtn.closest('.video-item');
        const video = item.querySelector('.myVideo');
        const playBtn = item.querySelector('.playBtn');

        video.pause();
        pauseBtn.style.display = 'none';
        playBtn.style.display = 'inline-block';
    }
});

</script>



{% schema %}
{
    "name": "Section tiktok",
    "settings": [
        {
            "type": "richtext",
            "id": "main_title",
            "label": "Title"
        },
        {
            "type": "range",
            "id": "products_count",
            "min": 2,
            "max": 24,
            "label": "t:global.product_list.products_to_show",
            "default": 9
        },
    ],
    "blocks": [
        {
            "type": "video",
            "name": "Video",
            "settings": [
                {
                    "type": "url",
                    "id": "main_url",
                    "label": "Url button"
                },
                {
                    "type": "video",
                    "id": "video_file",
                    "label": "Upload video"
                },
                {
                    "type": "product",
                    "id": "main_product",
                    "label": "Product"
                }
            ]
        }
    ],
    "presets": [
        {
            "name": "Section tiktok"
        }
    ]
}
{% endschema %}
