{%- if search.performed -%}
  {%- liquid
    assign active_values_count = 0

    for filter in search.filters
      if filter.type == 'price_range'
        if filter.max_value.value != blank or filter.min_value.value != blank
          assign active_values_count = active_values_count | plus: 1
        endif
      else
        assign active_values_count = active_values_count | plus: filter.active_values.size
      endif
    endfor

    if section.settings.show_filters and search.filters.size > 0
      assign show_filters = true
    else
      assign show_filters = false
    endif

    # First, we retrieve, based on the merchant settings, the user preferences and the available space the most appropriate size
    assign products_mobile_grid_mode = cart.attributes.products_mobile_grid_mode

    if request.design_mode
      # In the theme editor we do not use the choice selected manually, to reduce confusion when changing the theme editor values
      assign products_desktop_grid_mode = section.settings.products_size_desktop
    elsif section.settings.show_grid_mode_selector
      assign products_desktop_grid_mode = cart.attributes.products_desktop_grid_mode | default: section.settings.products_size_desktop
    else
      assign products_desktop_grid_mode = section.settings.products_size_desktop
    endif

    if products_mobile_grid_mode == blank or request.design_mode
      if section.settings.products_per_row_mobile == '1'
        assign products_mobile_grid_mode = 'large'
      else
        assign products_mobile_grid_mode = 'medium'
      endif
    endif
  -%}

  {%- if search.results_count > 0 or active_values_count > 0 -%}
    {{ 'quick-buy.css' | asset_url | stylesheet_tag }}

    <style>
      .shopify-section--main-search {
        --product-list-horizontal-spacing-factor: {{ section.settings.horizontal_spacing_factor }};
        --product-list-vertical-spacing-factor: {{ section.settings.vertical_spacing_factor }};

        {% comment %}On mobile, it's simple! No sidebar or whatever{% endcomment %}
        --collection-items-per-row-medium: 2;
        --collection-items-per-row-large: 1;
      }

      .shopify-section--main-search .product-list {
        --product-list-max-items-per-row-allowed: 99 !important; {% comment %}On collection page, we explicitly set a number of items so we don't want this{% endcomment %}
      }

       @media screen and (min-width: 700px) {
        .shopify-section--main-search {
          {% comment %}On tablet, we do not have any sidebar, so we can fix it{% endcomment %}
          --collection-items-per-row-compact: 4;
          --collection-items-per-row-medium: 3;
          --collection-items-per-row-large: 2;
        }
      }

      @media screen and (min-width: 700px) {
        #shopify-section-{{ section.id }} {
          --product-list-items-per-row: 3;
        }
      }

      @media screen and (min-width: 1000px) {
        #shopify-section-{{ section.id }} .collection {
          {%- if show_filters -%}
            --collection-grid-template: var(--collection-sidebar-width, 0) minmax(0,1fr);
          {%- endif -%}
        }
      }

      @media screen and (min-width: 1400px) {
        #shopify-section-{{ section.id }} {
          --product-list-items-per-row: 4;
        }
      }
    </style>

    {%- paginate search.results by 48 -%}
      <div class="section-spacing section-spacing--tight color-scheme color-scheme--{{ section.settings.color_scheme.id }}">
        <div class="container">
          <div class="section-stack">
            <div class="section-header justify-self-center text-center">
              <div class="v-stack gap-4">
                <h1 class="h2">{{ 'search.general.title' | t }}</h1>
                <p>{{ 'search.results_count_for_terms' | t: count: search.results_count, terms: search.terms }}</p>
              </div>
            </div>

            <div class="main-search">
              <x-tabs class="main-search__tabs content-tabs content-tabs--center">
                <template shadowrootmode="open">
                  <style>
                    .scrollable::-webkit-scrollbar {
                      display: none;
                    }
                  </style>

                  {%- assign unique_types = search.results | map: 'object_type' | uniq -%}

                  {%- if search.types.size > 1 and unique_types.size > 1 -%}
                    <div part="tab-list-scrollable" class="scrollable">
                      <slot role="tablist" part="tab-list" name="title"></slot>
                    </div>
                  {%- endif -%}

                  <slot part="tab-panels" name="content"></slot>
                </template>

                {%- assign product_results = search.results | where: 'object_type', 'product' -%}
                {%- assign article_results = search.results | where: 'object_type', 'article' -%}
                {%- assign page_results = search.results | where: 'object_type', 'page' -%}

                {%- if product_results.size > 0 or active_values_count > 0 -%}
                  <button type="button" class="h6" role="tab" slot="title">{{ 'search.general.products' | t }}</button>

                  <div
                    class="main-search__resource-item"
                    role="tabpanel"
                    slot="content"
                    {% cycle 'result_tab': '', 'hidden', 'hidden', 'hidden' %}
                  >
                    <div class="v-stack gap-6 sm:gap-12">
                      {%- if show_filters or section.settings.show_sort_by -%}
                        <height-observer variable="collection-toolbar" class="collection-toolbar full-bleed">
                          <div class="collection-toolbar__button-list">
                            {%- if show_filters -%}
                              <div class="collection-toolbar__button-container md:hidden">
                                <button
                                  type="button"
                                  aria-controls="facets-drawer"
                                  class="collection-toolbar__button heading text-xxs w-full"
                                >
                                  {{- 'collection.faceting.filter_button' | t }}
                                  {% if active_values_count > 0 %}({{ active_values_count }}){% endif -%}
                                </button>
                              </div>
                            {%- endif -%}

                            {%- if section.settings.show_sort_by -%}
                              {%- assign selected_sort_by_value = search.sort_by | default: search.default_sort_by -%}

                              <div class="collection-toolbar__button-container">
                                <button
                                  type="button"
                                  aria-controls="sort-by-popover"
                                  class="collection-toolbar__button heading text-xxs w-full"
                                >
                                  <span class="text-with-icon justify-center">
                                    {{- 'collection.faceting.sort_by' | t -}}
                                    {%- render 'icon' with 'chevron-down' -%}
                                  </span>
                                </button>

                                <facets-sort-popover
                                  id="sort-by-popover"
                                  section-id="{{ section.id }}"
                                  class="popover popover--bottom-end color-scheme color-scheme--dialog"
                                  close-on-listbox-select
                                >
                                  <p class="h4" slot="header">{{ 'collection.faceting.sort_by' | t }}</p>

                                  <x-listbox class="popover__value-list">
                                    {%- for sort_option in search.sort_options -%}
                                      {%- if sort_option.name != blank -%}
                                        <button
                                          type="button"
                                          class="popover__value-option group"
                                          role="option"
                                          value="{{ sort_option.value }}"
                                          {% if sort_option.value == selected_sort_by_value %}
                                            aria-selected="true"
                                          {% endif %}
                                        >
                                          <span class="reversed-link">{{ sort_option.name }}</span>
                                        </button>
                                      {%- endif -%}
                                    {%- endfor -%}
                                  </x-listbox>
                                </facets-sort-popover>
                              </div>
                            {%- endif -%}
                          </div>
                        </height-observer>
                      {%- endif -%}

                      <div class="collection collections-products-main">
                        {%- if show_filters -%}
                          <facets-drawer
                            id="facets-drawer"
                            class="facets-drawer drawer drawer--sm color-scheme color-scheme--dialog md:hidden"
                          >
                            <p class="h4" slot="header">{{ 'collection.faceting.filters' | t }}</p>

                            {%- render 'facets',
                              results: search,
                              show_filters: section.settings.show_filters,
                              open_filters_by_default: section.settings.open_filters_by_default,
                              update_on_change: false,
                              context: 'drawer'
                            -%}

                            <div slot="footer">
                              {%- assign button_content = 'collection.faceting.apply_filters' | t -%}

                              <dialog-close-button class="contents">
                                {%- render 'button', type: 'button', content: button_content, stretch: true -%}
                              </dialog-close-button>
                            </div>
                          </facets-drawer>

                          <safe-sticky class="facets-sidebar md-max:hidden">
                            {%- render 'facets',
                              results: search,
                              show_filters: section.settings.show_filters,
                              open_filters_by_default: section.settings.open_filters_by_default,
                              update_on_change: true,
                              context: 'sidebar'
                            -%}
                          </safe-sticky>
                        {%- endif -%}

                        {%- if search.results_count == 0 -%}
                          <div class="empty-state">
                            <div class="v-stack gap-4">
                              <p>{{ 'collection.faceting.no_results' | t }}</p>

                              {%- assign button_content = 'collection.faceting.clear_filters' | t -%}
                              {%- capture clean_search_url -%}{{ routes.search_url }}?q={{ search.terms }}{%- endcapture -%}

                              <facet-link>
                                {%- render 'button', href: clean_search_url, content: button_content -%}
                              </facet-link>
                            </div>
                          </div>
                        {%- else -%}
                          <div class="collection__main">
                            {%- render 'active-facets', results: search -%}

                            <product-list
                              id="product-list-{{ section.id }}"
                              class="product-list"
                              collection-mobile-layout="{{ products_mobile_grid_mode }}"
                              collection-desktop-layout="{{ products_desktop_grid_mode }}"
                            >
                              {%- for product in product_results -%}
                                {%- render 'product-card',
                                  product: product,
                                  stacked: true,
                                  reveal: settings.stagger_products_apparition,
                                  position: forloop.index
                                -%}
                              {%- endfor -%}
                            </product-list>

                            {%- render 'pagination', paginate: paginate, facet: true -%}
                          </div>
                        {%- endif -%}
                      </div>
                    </div>
                  </div>
                {%- endif -%}

                {%- if article_results.size > 0 -%}
                  <button type="button" class="h6" role="tab" slot="title">{{ 'search.general.posts' | t }}</button>

                  <div
                    class="main-search__resource-item"
                    role="tabpanel"
                    slot="content"
                    {% cycle 'result_tab': '', 'hidden', 'hidden', 'hidden' %}
                  >
                    <blog-posts
                      class="blog-post-list justify-center"
                      {% if settings.stagger_blog_posts_apparition %}
                        reveal-on-scroll="true"
                      {% endif %}
                    >
                      {%- capture sizes -%}(max-width: 699px) 95vw, (max-width: 1149px) calc(100vw / 2), calc((80rem - (5rem * (3 - 1) / 3){%- endcapture -%}

                      {%- for article in article_results -%}
                        {%- render 'blog-post-card',
                          article: article,
                          show_category: section.settings.show_category,
                          show_excerpt: section.settings.show_excerpt,
                          show_read_more: section.settings.show_read_more,
                          sizes: sizes,
                          position: forloop.index
                        -%}
                      {%- endfor -%}
                    </blog-posts>
                  </div>
                {%- endif -%}

                {%- if page_results.size > 0 -%}
                  <button type="button" class="h6" role="tab" slot="title">{{ 'search.general.pages' | t }}</button>

                  <div
                    class="main-search__resource-item"
                    role="tabpanel"
                    slot="content"
                    {% cycle 'result_tab': '', 'hidden', 'hidden', 'hidden' %}
                  >
                    <ul class="main-search__linklist v-stack gap-3 unstyled-list" role="list">
                      {%- for page in page_results -%}
                        <li>
                          <a href="{{ page.url }}" class="link-reverse" data-instant>{{ page.title }}</a>
                        </li>
                      {%- endfor -%}
                    </ul>
                  </div>
                {%- endif -%}
              </x-tabs>
            </div>
          </div>
        </div>
      </div>
    {%- endpaginate -%}
  {%- else -%}
    <div class="color-scheme color-scheme--{{ section.settings.color_scheme.id }}">
      <div class="container container--xs">
        <div class="empty-state">
          <div class="v-stack gap-4">
            <div class="prose">
              <h1 class="h4">{{ 'search.general.title' | t }}</h1>
              <p>{{ 'search.general.no_results' | t: terms: search.terms }}</p>
            </div>

            <form class="main-search-form" action="{{ routes.search_url }}" method="get" role="search">
              {%- assign placeholder = 'search.general.search_placeholder' | t -%}

              <div class="relative">
                {%- render 'input',
                  type: 'text',
                  name: 'q',
                  label: placeholder,
                  autocomplete: 'off',
                  autocorrect: 'off'
                -%}
                <button type="submit" class="input-suffix link-faded">{% render 'icon' with 'search' %}</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  {%- endif -%}
{%- else -%}
  <div class="color-scheme color-scheme--{{ section.settings.color_scheme.id }}">
    <div class="container container--xs">
      <div class="empty-state">
        <div class="v-stack gap-4">
          <div class="prose">
            <h1 class="h4">{{ 'search.general.title' | t }}</h1>
          </div>

          <form class="main-search-form" action="{{ routes.search_url }}" method="get" role="search">
            {%- assign placeholder = 'search.general.search_placeholder' | t -%}

            <div class="relative">
              {%- render 'input',
                type: 'text',
                name: 'q',
                label: placeholder,
                autocomplete: 'off',
                autocorrect: 'off'
              -%}
              <button type="submit" class="input-suffix link-faded">{% render 'icon' with 'search' %}</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
{%- endif -%}

{% render 'quick-buy-popup' %}

<script>
document.addEventListener("DOMContentLoaded", () => {

  const formatMoney = cents => "$" + (cents / 100).toFixed(2);

  const getCoreFromVariant = src => {
    const fileName = src.split("/").pop().split("?")[0];
    return fileName.replace(/_100x100\.(jpg|png|webp)$/i, "");
  };

  const getCoreFromSlide = src => {
    const fileName = src.split("/").pop().split("?")[0];
    return fileName.replace(/_400x\.(jpg|png|webp)$/i, "");
  };
  
  function setupQuantityControls(modal, qtyInput, hiddenQtyInput, modalPrice) {
    const updatePrice = () => {
      let val = parseInt(qtyInput.value) || 1;
      let price = parseInt(qtyInput.dataset.currentPrice || 0);
      modalPrice.textContent = formatMoney(price * val);
      modal.querySelector(".modal-product-price-text").textContent = formatMoney(price * val);
      hiddenQtyInput.value = val;
    };
    
    modal.querySelectorAll(".qty-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        let val = parseInt(qtyInput.value) || 1;
        if (btn.dataset.action === "increase") val++;
        else if (btn.dataset.action === "decrease" && val > 1) val--;
        qtyInput.value = val;
        updatePrice();
      });
    });

  qtyInput.addEventListener("input", updatePrice);
}

function updateModal(modal, productData) {
  const detailsLink = modal.querySelector(".modal-more-details");
  if (detailsLink) {
    detailsLink.href = `/products/${productData.handle}`;
  }
  
  const modalContent = modal.querySelector(".modal-content");
  const addToCartBtn = modalContent.querySelector(".modal-buy-button-cart");
  const chooseSizeBtn = modalContent.querySelector(".modal-chose-size-cart");
  
  if (addToCartBtn && chooseSizeBtn) {
    addToCartBtn.style.display = "none";
    chooseSizeBtn.style.display = "inline-block";
  } 
  
  let imageInput = modalContent.querySelector("input[name='image']");
  if (!imageInput) {
    imageInput = document.createElement("input");
    imageInput.type = "hidden";
    imageInput.name = "image";
    modalContent.querySelector("form").appendChild(imageInput);
  }
    
  const modalTitle = modalContent.querySelector(".modal-product-title");
  const imagesWrapper = modalContent.querySelector(".modal-images-container");
  const variantsContainer = modalContent.querySelector(".modal-variants-container");
  const modalPrice = modalContent.querySelector(".modal-product-price");
  const modalComparePrice = modalContent.querySelector(".modal-product-compare-price");
  const qtyInput = modalContent.querySelector("input[name='quantity']");
  const hiddenQtyInput = modalContent.querySelector("input[name='quantity'][type='hidden']");
  const hiddenInput = modalContent.querySelector("input[name='id']");
  const option1Input = modalContent.querySelector("input[name='option1']");
  const option2Input = modalContent.querySelector("input[name='option2']");



  modalTitle.textContent = productData.title;
  modalTitle.href = `/products/${productData.handle}`;


  modal.querySelector(".close-modal-collection-products")?.addEventListener("click", closeModal);
  const option1Block = modalContent.querySelector(".option1-size").closest(".modal-size-buttons");
  const option2Block = modalContent.querySelector(".option2-size").closest(".modal-size-buttons");
  const singleBlock = modalContent.querySelector(".modal-size-buttons:not(:has(.option1-size)):not(:has(.option2-size))");

  const option1Wrapper = modalContent.querySelector(".option1-size");
  const option2Wrapper = modalContent.querySelector(".option2-size");
  const singleWrapper = singleBlock.querySelector(".size-buttons-wrapper");

  option1Wrapper.innerHTML = "";
  option2Wrapper.innerHTML = "";
  singleWrapper.innerHTML = "";

  const option1Values = [
    ...new Set(productData.variants.map(v => !isNaN(Number(v.option1)) ? v.option1 : null).filter(Boolean))
  ];
  const option2Values = [
    ...new Set(productData.variants.map(v => !isNaN(Number(v.option2)) ? v.option2 : null).filter(Boolean))
  ];
  
  const hasNumericOption1 = option1Values.length > 0;
  const hasNumericOption2 = option2Values.length > 0;
  if(productData.optionsName == "Size" && hasNumericOption1 && !hasNumericOption2){
    console.log("productData.optionsName")
  }
  if (hasNumericOption1 && hasNumericOption2) {
      
    option1Block.style.display = "block";
    option2Block.style.display = "block";
    singleBlock.style.display = "none";

    option1Values.forEach(size => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "size-button px-3 py-1 border rounded text-sm hover:bg-gray-100";
      btn.textContent = size;
      btn.dataset.size = size;
      btn.dataset.option = "option1";
      option1Wrapper.appendChild(btn);
    });

    option2Values.forEach(size => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "size-button px-3 py-1 border rounded text-sm hover:bg-gray-100";
      btn.textContent = size;
      btn.dataset.size = size;
      btn.dataset.option = "option2";
      option2Wrapper.appendChild(btn);
    });

  } else if (hasNumericOption1 && !hasNumericOption2) {
    option1Block.style.display = "none";
    option2Block.style.display = "none";
    singleBlock.style.display = "block";

    option1Values.forEach(size => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "size-button px-3 py-1 border rounded text-sm hover:bg-gray-100";
      btn.textContent = size;
      btn.dataset.size = size;
      btn.dataset.option = "option1";
      singleWrapper.appendChild(btn);
    });
  
  } else {
      
    option1Block.style.display = "none";
    option2Block.style.display = "none";
    singleBlock.style.display = "block";

    const optionValues = [
      ...new Set(productData.variants.map(v => v.option2).filter(Boolean))
    ];

    optionValues.forEach(size => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "size-button px-3 py-1 border rounded text-sm hover:bg-gray-100";
      btn.textContent = size.replace(/\D/g, "");
      btn.dataset.size = size;
      btn.dataset.option = "option1";
      singleWrapper.appendChild(btn);
    });
  }


  const sizeButtons = modalContent.querySelectorAll(".size-button");
  let currentVariantPrice = 0;

    var mainOption1 = false;
    var mainOption2 = false;

    sizeButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const parentWrapper = btn.closest(".size-buttons-wrapper");
        
        parentWrapper.querySelectorAll(".size-button").forEach(b => b.classList.remove("active-size-main"));
        btn.classList.add("active-size-main");
        
        const selectedSize = btn.dataset.size;   
        const optionType = btn.dataset.option;  
        
        const productHasNumericOption1 = productData.variants.some(v => !isNaN(Number(v.option1)));


        const variantMain = productData.variants;
        let hasOption2 = true; 
        
        for (let i = 0; i < variantMain.length; i++) {
          if (variantMain[i].option2 == null) { 
            hasOption2 = false;
            break;
          }
        }

        if(productHasNumericOption1 && !hasOption2){
          mainOption1 = true;
          mainOption2 = true;
          const sizeValue = document.querySelector(".main-modal-size")
          sizeValue.textContent = btn.dataset.size.replace(/\D/g, "");
      
          option2Input.value = selectedSize;
        
        } else if (productHasNumericOption1) {
          
          if (optionType === "option1") {
            const sizeValue1 = document.querySelector(".main-modal-first-size")
            sizeValue1.textContent = btn.dataset.size;
            mainOption1 = true;
            option1Input.value = selectedSize;
          } else if (optionType === "option2") {
            const sizeValue2 = document.querySelector(".main-modal-second-size")
            sizeValue2.textContent = btn.dataset.size;
            mainOption2 = true;
            option2Input.value = selectedSize;
          }
        } else {
          mainOption1 = true;
          mainOption2 = true;
          const sizeValue = document.querySelector(".main-modal-size")
          sizeValue.textContent = btn.dataset.size.replace(/\D/g, "");
      
          option2Input.value = selectedSize;
        }
        if(mainOption1 && mainOption2){
          if (addToCartBtn && chooseSizeBtn) {
            addToCartBtn.style.display = "inline-block";
            chooseSizeBtn.style.display = "none";
          }
        }
        
        const normalize = val => (!isNaN(Number(val)) ? Number(val) : val);
        
        const selectedVariant = productData.variants.find(v =>
          normalize(v.option1) === normalize(option1Input.value) &&
          normalize(v.option2) === normalize(option2Input.value)
        );
        
        if (selectedVariant) {
          hiddenInput.value = selectedVariant.id;
          currentVariantPrice = selectedVariant.price;
          qtyInput.dataset.currentPrice = selectedVariant.price;
          
          modalPrice.textContent = formatMoney(currentVariantPrice * (parseInt(qtyInput.value) || 1));
          hiddenQtyInput.value = qtyInput.value;
          
          if (selectedVariant.compare_at_price && selectedVariant.compare_at_price > selectedVariant.price) {
            modalComparePrice.textContent = formatMoney(selectedVariant.compare_at_price * parseInt(qtyInput.value));
            modalComparePrice.style.display = "inline";
          } else {
            modalComparePrice.style.display = "none";
          }
          
          if (addToCartBtn && currentVariantPrice) {
            const qty = parseInt(qtyInput.value) || 1;
            addToCartBtn.querySelector(".modal-product-price-text").textContent = formatMoney(currentVariantPrice * qty);
          }
          
          let optionsToSend = {
            option1: !isNaN(Number(selectedVariant.option1)) 
            ? Number(selectedVariant.option1) 
            : (selectedVariant.option1 || ""),
            option2: selectedVariant.option2 || "",
            image: selectedVariant.featured_image?.src || ""
          };
          
          if (!productHasNumericOption1) {
            optionsToSend.option2 = selectedSize;
            option2Input.value = selectedSize;
          }
          
          imageInput.value = optionsToSend.image;
        }
      });
      
      function selectFirstVariant() {
        let firstVariant = productData.variants[0];
        if (!firstVariant) return;
        
        const hiddenInput = modal.querySelector("input[name='id']");
        const option1Input = modal.querySelector("input[name='option1']");
        const option2Input = modal.querySelector("input[name='option2']");
        const imageInput = modal.querySelector("input[name='image']");
        const modalPrice = modal.querySelector(".modal-product-price");
        const hiddenQtyInput = modal.querySelector("input[name='quantity'][type='hidden']");
        const qtyInput = modal.querySelector("input[name='quantity']");
        
        hiddenInput.value = firstVariant.id;
        option1Input.value = firstVariant.option1 || "";
        option2Input.value = firstVariant.option2 || "";
        imageInput.value = firstVariant.featured_image?.src || "";
        
        const qty = parseInt(qtyInput.value) || 1;
        modalPrice.textContent = "$" + (firstVariant.price * qty / 100).toFixed(2);
        qtyInput.dataset.currentPrice = firstVariant.price;
        
        modal.querySelector(".modal-product-price-text").textContent = "$" + (firstVariant.price / 100).toFixed(2);
        hiddenQtyInput.value = qty;
        
        const sizeButtons = modal.querySelectorAll(".size-button");
        sizeButtons.forEach(btn => {
          btn.classList.remove("active-size-main");
          if (btn.dataset.size === firstVariant.option1 || btn.dataset.size === firstVariant.option2) {
            btn.classList.add("active-size-main");
          }
        });
        
        const swiperInstance = modal.querySelector(".modal-swiper-collection").swiper;
        const variantCore = firstVariant.featured_image?.src?.split("/").pop().replace(/_100x100\.(jpg|png|webp)$/i, "");
        const slidesArray = Array.from(modal.querySelectorAll(".modal-swiper-collection .swiper-slide:not(.swiper-slide-duplicate) img"));
        const slidesCore = slidesArray.map(img => img.src.split("/").pop().replace(/_400x\.(jpg|png|webp)$/i, ""));
        const targetSlideIndex = slidesCore.findIndex(c => c === variantCore);
        if (targetSlideIndex !== -1) swiperInstance.slideToLoop(targetSlideIndex, 0);
      }
      
      selectFirstVariant();
    });
    
    option1Wrapper.querySelectorAll(".size-button").forEach(btn => btn.classList.remove("active-size-main"));
    option2Wrapper.querySelectorAll(".size-button").forEach(btn => btn.classList.remove("active-size-main"));
    singleWrapper.querySelectorAll(".size-button").forEach(btn => btn.classList.remove("active-size-main"));

    imagesWrapper.innerHTML = "";
    const addedImages = new Set();
    productData.images.forEach((imgSrc, i) => {
      if (!addedImages.has(imgSrc)) {
        addedImages.add(imgSrc);
        const slide = document.createElement("div");
        slide.className = "swiper-slide";
        slide.dataset.image = imgSrc;
        slide.innerHTML = `
          <a href='/products/${productData.handle}'>
            <img src="${imgSrc}" alt="${productData.title} ${i + 1}" class="w-full h-auto">
          </a>
        `;
        imagesWrapper.appendChild(slide);
      }
    });

    const swiperInstance = new Swiper(modalContent.querySelector(".modal-swiper-collection"), {
      slidesPerView: 1,
      spaceBetween: 10,
      loop: true,
      navigation: {
        nextEl: modalContent.querySelector(".swiper-button-next"),
        prevEl: modalContent.querySelector(".swiper-button-prev"),
      },
      pagination: {
        el: modalContent.querySelector(".swiper-pagination"),
        clickable: true,
      },
    });

    variantsContainer.innerHTML = "";
    const addedVariantImages = new Set();
    const allVariantButtons = [];

    productData.variants.forEach((variant, index) => {
      if (!variant.featured_image) return;
      const imgSrc = variant.featured_image.src;
      if (addedVariantImages.has(imgSrc)) return;
      addedVariantImages.add(imgSrc);

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = `variant-button-collection-main variant-thumb w-8 h-8 rounded-full overflow-hidden border ${index === 0 ? "ring-2 ring-black" : "border-gray-300 hover:border-black"}`;
      btn.dataset.image = imgSrc;
      btn.dataset.variantId = variant.id;
      btn.dataset.price = variant.price;
      btn.dataset.compareAtPrice = variant.compare_at_price || 0;
      btn.innerHTML = `<img src="${imgSrc.replace('.jpg','_100x100.jpg')}" alt="${variant.title}" class="w-full h-full object-cover">`;
      
      btn.addEventListener("click", () => {
        currentVariantPrice = variant.price;
        modalPrice.textContent = formatMoney(currentVariantPrice * (parseInt(qtyInput.value) || 1));
        hiddenQtyInput.value = qtyInput.value;
        hiddenInput.value = variant.id;
        
        if (variant.compare_at_price && variant.compare_at_price > variant.price) {
          modalComparePrice.textContent = formatMoney(variant.compare_at_price * parseInt(qtyInput.value));
          modalComparePrice.style.display = "inline";
        } else {
          modalComparePrice.style.display = "none";
        }
        
        variantsContainer.querySelectorAll("button").forEach(b => b.classList.remove("ring-2", "ring-black"));
        btn.classList.add("ring-2", "ring-black");
        
        option1Input.value = variant.option1 || "";
        option2Input.value = variant.option2 || "";
        imageInput.value = variant.featured_image?.src || "";
        
        const selectedOptionsDisplay = modalContent.querySelector(".modal-selected-options");
        if (selectedOptionsDisplay) {
          selectedOptionsDisplay.textContent = `${variant.option1 || ""} ${variant.option2 || ""}`.trim();
        }
        
        const variantCore = getCoreFromVariant(btn.querySelector("img").src);
        const slidesArray = Array.from(modalContent.querySelectorAll(".modal-swiper-collection .swiper-slide:not(.swiper-slide-duplicate) img"));
        const slidesCore = slidesArray.map(img => getCoreFromSlide(img.src));
        
        const targetSlideIndex = slidesCore.findIndex(c => c === variantCore);
        if (targetSlideIndex !== -1) {
          swiperInstance.slideToLoop(targetSlideIndex, 300);
        }
        
        const optionsToSend = {
          option1: variant.option1 || "",
          option2: variant.option2 || "",
          image: variant.featured_image?.src || "",
        };
        
        
        option1Input.value = optionsToSend.option1;
        option2Input.value = optionsToSend.option2;
        imageInput.value = optionsToSend.image;
        hiddenInput.value = variant.id; 
      });

      allVariantButtons.push(btn);
    });

    const maxVisibleVariants = 6;
    allVariantButtons.forEach((btn, i) => {
      if (i < maxVisibleVariants) {
        variantsContainer.appendChild(btn);
      } else {
        btn.style.display = "none";
        variantsContainer.appendChild(btn);
      }
    });

    if (allVariantButtons.length > maxVisibleVariants) {
      const showAllBtn = document.createElement("button");
      showAllBtn.innerHTML = `
        <div class='main_button-show'>
          <img src="{{ 'VectorModal12.svg' | asset_url }}" alt="All" />
        </div>
      `;
      showAllBtn.className = "show-all-variants-btn text-sm text-blue-600 hover:underline mt-2";
      showAllBtn.type = "button";

      showAllBtn.addEventListener("click", () => {
        allVariantButtons.forEach(btn => {
          btn.style.display = "flex";
        });
        showAllBtn.remove();
      });

      variantsContainer.appendChild(showAllBtn);
    }

    qtyInput.value = 1;
    hiddenQtyInput.value = 1;



    setupQuantityControls(modal, qtyInput, hiddenQtyInput, modalPrice);

    const reviewsCount = productData.reviewsCount || 0;
    const avgRating = productData.avgRating || 0;
    const roundedRating = Math.round(avgRating);

    const reviewsContainer = modal.querySelector(".modal-reviews");
    const starsContainer = modal.querySelector(".modal-stars");
    const ratingText = modal.querySelector(".modal-rating-text");

    if (reviewsCount > 0) {
      starsContainer.innerHTML = "";
      for (let i = 1; i <= 5; i++) {
        const star = document.createElement("span");
        star.textContent = i <= roundedRating ? "★" : "☆";
        star.style.color = i <= roundedRating ? "#FBBF24" : "#D1D5DB";
        star.style.fontSize = "18px";
        starsContainer.appendChild(star);
      }
      ratingText.textContent = `${avgRating.toFixed(2)}/5.00`;
      reviewsContainer.style.display = "flex";
    } else {
      reviewsContainer.style.display = "none";
    }

    document.body.style.overflow = "hidden";
    function closeModal() {
      modal.remove();
      document.body.style.overflow = "";
    }
    modal.querySelector(".close-modal")?.addEventListener("click", closeModal);
    modal.querySelector(".modal-overlay").addEventListener("click", closeModal);
  }
  document.querySelectorAll(".add-to-cart-form").forEach(form => {
    const triggerBtn = form.querySelector("button, input[type='submit']");
    if (triggerBtn) {
      triggerBtn.addEventListener("click", e => {
        e.preventDefault();
        document.querySelector(".container-modal-collection-main")?.remove();
        const productDataElem = form.querySelector(".product-data");
        const optionsName = productDataElem.dataset.productOptions;
        const handle = productDataElem.dataset.productHandle;
        const variants = JSON.parse(productDataElem.querySelector(".product-variants-json").textContent);
        const images = JSON.parse(productDataElem.dataset.productImages);
        const title = productDataElem.dataset.productTitle;
        
        const reviewsCount = parseInt(productDataElem.dataset.reviewsCount) || 0;
        const avgRating = parseFloat(productDataElem.dataset.avgRating) || 0;
        
        const template = document.querySelector("#addToCartModalTemplate-{{ section.id }}");
        const modalClone = template.content.cloneNode(true);
        const modal = modalClone.querySelector(".container-modal-collection-main");
        
        document.body.appendChild(modal);
        updateModal(modal, { optionsName, title, images, variants, reviewsCount, avgRating, handle });

        
        modal.classList.remove("hidden");
      });
    }
  });
});
</script>

{% schema %}
{
  "name": "t:sections.main_search.name",
  "class": "shopify-section--main-search",
  "tag": "section",
  "settings": [
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:global.colors.scheme",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "t:global.product_list.product_list_category"
    },
    {
      "type": "select",
      "id": "products_size_desktop",
      "label": "t:global.product_list.products_size_desktop",
      "info": "t:global.product_list.products_size_desktop_info",
      "options": [
        {
          "value": "compact",
          "label": "t:global.product_list.products_size_desktop_options.compact"
        },
        {
          "value": "medium",
          "label": "t:global.product_list.products_size_desktop_options.medium"
        },
        {
          "value": "large",
          "label": "t:global.product_list.products_size_desktop_options.large"
        }
      ],
      "default": "medium"
    },
    {
      "type": "header",
      "content": "t:sections.main_search.product_results_category"
    },
    {
      "type": "checkbox",
      "id": "show_sort_by",
      "label": "t:global.faceting.show_sort_by",
      "default": true
    },
    {
      "type": "range",
      "id": "products_per_page",
      "label": "t:global.faceting.products_per_page",
      "min": 8,
      "max": 50,
      "step": 1,
      "default": 24
    },
    {
      "type": "header",
      "content": "t:global.product_list.spacing_category",
      "info": "t:global.product_list.spacing_category_info"
    },
    {
      "type": "range",
      "min": 0.2,
      "max": 2,
      "step": 0.1,
      "id": "horizontal_spacing_factor",
      "label": "t:global.product_list.horizontal_spacing_factor",
      "default": 1
    },
    {
      "type": "range",
      "min": 0.2,
      "max": 2,
      "step": 0.1,
      "id": "vertical_spacing_factor",
      "label": "t:global.product_list.vertical_spacing_factor",
      "default": 1
    },
    {
      "type": "header",
      "content": "t:sections.main_search.product_filters_category"
    },
    {
      "type": "checkbox",
      "id": "show_filters",
      "label": "t:global.faceting.show_filters",
      "info": "t:global.faceting.show_filters_info",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_filter_group_name",
      "label": "t:global.faceting.show_group_name",
      "info": "t:global.faceting.show_group_name_info",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_filter_values_count",
      "label": "t:global.faceting.show_filter_values_count",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "open_filters_by_default",
      "label": "t:global.faceting.open_filters_by_default",
      "default": false
    },
    {
      "type": "header",
      "content": "t:sections.main_search.blog_post_results_category"
    },
    {
      "type": "checkbox",
      "id": "show_category",
      "label": "t:global.blog.show_category",
      "info": "t:global.blog.show_category_info",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_excerpt",
      "label": "t:global.blog.show_excerpt",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_read_more",
      "label": "t:global.blog.show_read_more",
      "default": true
    }
  ]
}
{% endschema %}
