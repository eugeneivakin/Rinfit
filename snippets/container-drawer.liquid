<div class="main-container-wrapper">
  <div id="{{ product.id }}" class="product-wrapper-main-drawer">
    
    <!-- ÐšÐ½Ð¾Ð¿ÐºÐ¸ ÐºÐ¾Ð»ÑŒÐ¾Ñ€Ñ–Ð² -->
    <div class="variant-thumbs-wrapper variant-thumbs-wrapper-drawer">
      {% assign assigned_images = '' %}
      {% assign variant_count = 0 %}

      {% for option_value in product.options_with_values[0].values %}
        {% assign variants_for_color = product.variants | where: 'option1', option_value %}
        {% assign variant = variants_for_color.first %}
        {% assign options2 = variants_for_color | map: 'option2' | uniq %}

        {% if variant.featured_image %}
          {% unless assigned_images contains variant.featured_image.src %}
            {% assign variant_count = variant_count | plus: 1 %}

            <button 
              type="button"
              class="variant-button-collection-main variant-thumb w-8 h-8 rounded-full 
                     {% if forloop.first %}ring-black active{% endif %}"
              data-color="{{ option_value }}"
              data-variant-id="{{ variant.id }}"
            >
              <img src="{{ variant.featured_image.src | img_url: '100x100' }}" alt="{{ option_value }}">
            </button>

            {% assign assigned_images = assigned_images | append: variant.featured_image.src | append: ',' %}
          {% endunless %}
        {% endif %}
      {% endfor %}
    </div>
    <!-- ÐšÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ñ€Ð¾Ð·Ð¼Ñ–Ñ€Ñ–Ð² -->
    <div class="product-sizes-main-drawer">
      {% for option_value in product.options_with_values[0].values %}
        {% assign variants_for_color = product.variants | where: 'option1', option_value %}
        {% assign sizes = variants_for_color | map: 'option2' | uniq %}

        <div class="size-group" data-color="{{ option_value }}" style="{% unless forloop.first %}display:none{% endunless %}">
          {% for size in sizes %}
            {% assign variant = variants_for_color | where: 'option2', size | first %}
            <button 
              type="button" 
              class="size-btn-drawer{% if forloop.first and forloop.parentloop.first %} active{% endif %}" 
              data-size="{{ size }}" 
              data-variant-id="{{ variant.id }}"
            >
              {% if size contains 'Select Size ' %}
                {{ size | remove: 'Select Size ' | strip }}
              {% elsif size contains 'Size' %}
                {{ size | remove: 'Size' | strip }}
              {% else %}
                {{ size }}
              {% endif %}
            </button>
          {% endfor %}
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- ÐšÐ½Ð¾Ð¿ÐºÐ° ÐºÑƒÐ¿Ñ–Ð²Ð»Ñ– -->
  <div class="main-container-product">
    <span class="main-price-product">{{ product.price | money }}</span>
    <button type="button" class="quick-buy-button" data-variant-id="{{ product.variants.first.id }}">
      Add to cart
    </button>
  </div>
</div>



<script>
  window.allProducts = window.allProducts || {};
  window.allProducts["{{ product.id }}"] = {{ product.variants | json }};
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.product-wrapper-main-drawer').forEach(productEl => {
    const variantButtons = productEl.querySelectorAll('.variant-button-collection-main');
    const sizeGroups = productEl.querySelectorAll('.size-group');
    const productId = productEl.id;
    const productVariants = window.allProducts[productId];
    const mainWrapper = productEl.closest('.main-container-wrapper');
    const quickBuyButton = mainWrapper.querySelector('.quick-buy-button');

    // Ð—Ð½Ð°Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ variantId Ð¿Ð¾ color + size
    function findVariantId(color, size) {
      const variant = productVariants.find(v => v.option1 === color && v.option2 === size);
      return variant ? variant.id : null;
    }

    // ÐŸÐ¾ÐºÐ°Ð·ÑƒÑ” Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð½Ñƒ Ð³Ñ€ÑƒÐ¿Ñƒ Ñ€Ð¾Ð·Ð¼Ñ–Ñ€Ñ–Ð² Ñ– Ð°ÐºÑ‚Ð¸Ð²ÑƒÑ” Ð¿Ð¾Ñ‚Ñ€Ñ–Ð±Ð½Ð¸Ð¹ Ñ€Ð¾Ð·Ð¼Ñ–Ñ€
    function showSizesForColor(color, preferredSize = null) {
      sizeGroups.forEach(group => {
        const isMatch = group.dataset.color === color;
        group.style.display = isMatch ? 'block' : 'none';

        if (isMatch) {
          const sizeButtons = group.querySelectorAll('.size-btn-drawer');

          let matchedBtn = null;
          sizeButtons.forEach(btn => {
            btn.classList.remove('active');
            if (preferredSize && btn.dataset.size === preferredSize) {
              matchedBtn = btn;
            }
          });

          const activeBtn = matchedBtn || sizeButtons[0];
          if (activeBtn) {
            activeBtn.classList.add('active');

            // â³ Ð”Ð¾Ð´Ð°Ñ”Ð¼Ð¾ Ð·Ð°Ñ‚Ñ€Ð¸Ð¼ÐºÑƒ Ð¿ÐµÑ€ÐµÐ´ Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½ÑÐ¼ variantId
            setTimeout(() => {
              const newVariantId = findVariantId(color, activeBtn.dataset.size);
              if (newVariantId && quickBuyButton) {
                quickBuyButton.setAttribute('data-variant-id', newVariantId);
                console.log(`ðŸŽ¯ ÐÐºÑ‚Ð¸Ð²Ð½Ð¸Ð¹ Ñ€Ð¾Ð·Ð¼Ñ–Ñ€ Ð¿Ñ–ÑÐ»Ñ Ð·Ð°Ñ‚Ñ€Ð¸Ð¼ÐºÐ¸: ${activeBtn.dataset.size}, variantId = ${newVariantId}`);
              }
            }, 100); // Ð·Ð°Ñ‚Ñ€Ð¸Ð¼ÐºÐ° 100 Ð¼Ñ
          }
        }
      });
    }

    // ÐšÐ»Ñ–Ðº Ð½Ð° ÐºÐ¾Ð»Ñ–Ñ€
    variantButtons.forEach(button => {
      button.addEventListener('click', () => {
        variantButtons.forEach(btn => btn.classList.remove('ring-black', 'active'));
        button.classList.add('ring-black', 'active');

        const selectedColor = button.dataset.color;

        const currentActiveSizeBtn = productEl.querySelector('.size-btn-drawer.active');
        const currentSize = currentActiveSizeBtn ? currentActiveSizeBtn.dataset.size : null;

        showSizesForColor(selectedColor, currentSize);
      });
    });

    // ÐšÐ»Ñ–Ðº Ð½Ð° Ñ€Ð¾Ð·Ð¼Ñ–Ñ€
    sizeGroups.forEach(group => {
      const sizeButtons = group.querySelectorAll('.size-btn-drawer');
      sizeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          sizeButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');

          const color = group.dataset.color;
          const size = btn.dataset.size;
          const variantId = findVariantId(color, size);

          if (variantId && quickBuyButton) {
            quickBuyButton.setAttribute('data-variant-id', variantId);
            console.log(`ðŸŸ¢ ÐžÐ±Ñ€Ð°Ð½Ð¸Ð¹ Ñ€Ð¾Ð·Ð¼Ñ–Ñ€: ${size}, variantId = ${variantId}`);
          }
        });
      });
    });

    // ÐšÐ»Ñ–Ðº Ð½Ð° ÐºÐ½Ð¾Ð¿ÐºÑƒ "Add to cart"
    if (quickBuyButton) {
      quickBuyButton.addEventListener('click', () => {
        const variantId = quickBuyButton.getAttribute('data-variant-id');
        console.log(`ðŸ›’ Ð”Ð¾Ð´Ð°Ñ”Ð¼Ð¾ Ð² ÐºÐ¾ÑˆÐ¸Ðº variantId: ${variantId}`);
        // Ð¢ÑƒÑ‚ Ð¼Ð¾Ð¶Ð½Ð° Ð´Ð¾Ð´Ð°Ñ‚Ð¸ AJAX Ð°Ð±Ð¾ Shopify API
      });
    }

    // Ð†Ð½Ñ–Ñ†Ñ–Ð°Ð»Ñ–Ð·Ð°Ñ†Ñ–Ñ: Ð°ÐºÑ‚Ð¸Ð²ÑƒÑ”Ð¼Ð¾ Ð¿ÐµÑ€ÑˆÐ¸Ð¹ ÐºÐ¾Ð»Ñ–Ñ€ Ñ– Ð¿ÐµÑ€ÑˆÐ¸Ð¹ Ñ€Ð¾Ð·Ð¼Ñ–Ñ€
    const firstColorBtn = variantButtons[0];
    if (firstColorBtn) {
      variantButtons.forEach(btn => btn.classList.remove('ring-black', 'active'));
      firstColorBtn.classList.add('ring-black', 'active');

      const selectedColor = firstColorBtn.dataset.color;
      showSizesForColor(selectedColor);
    }
  });
});

</script>

